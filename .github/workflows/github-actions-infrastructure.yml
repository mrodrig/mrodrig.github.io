name: Infrastructure (Terraform)
on: [push]
  # push:
  #   paths:
  #     # Only run jobs in this workflow if there are changes in the firebase directory
  #     - 'infrastructure/**'
jobs:
  deploy-dev:
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    needs: []
    environment:
      name: Development
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install Terraform 🔧
        run: |
          sudo apt-get update && sudo apt-get install -y gnupg software-properties-common
          wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg
          gpg --no-default-keyring --keyring /usr/share/keyrings/hashicorp-archive-keyring.gpg --fingerprint
          echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update
          sudo apt-get install terraform

      - name: Configure Variables and Credentials 🔐
        env:
          GOOGLE_CREDENTIALS_FILENAME: ${{ vars.GOOGLE_CREDENTIALS_FILENAME }}
          GOOGLE_CI_CREDENTIALS_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
          PROJECT_ENVIRONMENT: ${{ vars.ENVIRONMENT }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/${GOOGLE_CREDENTIALS_FILENAME}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> $GITHUB_ENV
          echo "PROJECT_ENVIRONMENT=$PROJECT_ENVIRONMENT" >> $GITHUB_ENV
          echo $GOOGLE_CI_CREDENTIALS_KEY > $GOOGLE_APPLICATION_CREDENTIALS

