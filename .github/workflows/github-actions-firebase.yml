name: Firebase
on: [push]
jobs:
  deploy-dev:
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    needs: []
    environment:
      name: Development
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install Firebase CLI 🔧
        run: |
          cd firebase
          npm install --location=global firebase-tools

      - name: Configure Credentials 🔐
        env:
          GOOGLE_CREDENTIALS_FILENAME: ${{ vars.GOOGLE_CREDENTIALS_FILENAME }}
          GOOGLE_CI_CREDENTIALS_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/${GOOGLE_CREDENTIALS_FILENAME}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> $GITHUB_ENV
          echo $GOOGLE_CI_CREDENTIALS_KEY > $GOOGLE_APPLICATION_CREDENTIALS

      - name: Deploy 🚀
        run: |
          echo $GOOGLE_APPLICATION_CREDENTIALS
          ls -la $GOOGLE_APPLICATION_CREDENTIALS
          cd firebase
          firebase use $ENVIRONMENT
          firebase deploy --project=$ENVIRONMENT

  deploy-prod:
    concurrency: 
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    needs: [deploy-dev]
    environment:
      name: Production-manual
      url: https://mrodrig.github.io
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install Firebase CLI 🔧
        run: |
          cd firebase
          npm install --location=global firebase-tools

      - name: Configure Credentials 🔐
        env:
          GOOGLE_CREDENTIALS_FILENAME: ${{ vars.GOOGLE_CREDENTIALS_FILENAME }}
          GOOGLE_CI_CREDENTIALS_KEY: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/${GOOGLE_CREDENTIALS_FILENAME}"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS" >> $GITHUB_ENV
          echo $GOOGLE_CI_CREDENTIALS_KEY > $GOOGLE_APPLICATION_CREDENTIALS

      - name: Deploy 🚀
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          cd firebase
          firebase use $ENVIRONMENT
          firebase deploy
